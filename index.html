<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>íŒ€ ì§‘ì¤‘ ì‹œê°„í‘œ</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { font-family: sans-serif; background: #f5f5f5; padding: 20px; }
    table { border-collapse: collapse; margin: 0 auto; }
    th, td {
      border: 1px solid #ccc; width: 80px; height: 50px;
      text-align: left; vertical-align: top; padding: 4px; cursor: pointer;
    }
    td .name-label {
      display: inline-block; padding: 2px 4px; margin: 1px 0;
      border-radius: 4px; font-size: 12px; color: white;
    }
    .controls { text-align: center; margin-bottom: 20px; }
    .controls input, .controls button { margin: 4px; }
    #userStatus { margin-top: 10px; color: #333; font-weight: bold; }
  </style>
</head>
<body>
  <h1 style="text-align:center">ğŸ“… íŒ€ ì§‘ì¤‘ ì‹œê°„í‘œ</h1>
  <div class="controls">
    <input type="text" id="username" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
    <button onclick="registerUser()">âœ… ë“±ë¡</button>
    <button onclick="clearMySchedule()">ğŸ§¹ ë‚´ ê¸°ë¡ ì´ˆê¸°í™”</button>
    <div id="userStatus"></div>
  </div>
  <table>
    <thead>
      <tr>
        <th>ì‹œê°„</th><th>ì¼</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th>
      </tr>
    </thead>
    <tbody id="schedule"></tbody>
  </table>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC2PvRwUfGo_UoGZUdWqekC1WxRvXs7Ma4",
      authDomain: "team-focus-schedule.firebaseapp.com",
      databaseURL: "https://team-focus-schedule-default-rtdb.firebaseio.com",
      projectId: "team-focus-schedule",
      storageBucket: "team-focus-schedule.appspot.com",
      messagingSenderId: "424187939160",
      appId: "1:424187939160:web:2c6e4e53859a7757b89818"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = null;
    let isMouseDown = false;
    const visited = new Set();
    const colorPalette = ["#3b82f6", "#10b981", "#f59e0b", "#ef4444", "#8b5cf6", "#ec4899"];
    const colors = {};

    const tableBody = document.getElementById("schedule");

    function getColor(name) {
      if (!colors[name]) {
        colors[name] = colorPalette[Object.keys(colors).length % colorPalette.length];
      }
      return colors[name];
    }

    function registerUser() {
      const name = document.getElementById("username").value.trim();
      if (!name) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
      currentUser = name;
      document.getElementById("userStatus").textContent = `í˜„ì¬ ì‚¬ìš©ì: ${currentUser}`;
    }

    function updateCellDisplay(cell, names) {
      cell.innerHTML = "";
      names.forEach(name => {
        const span = document.createElement("span");
        span.className = "name-label";
        span.textContent = name;
        span.style.backgroundColor = getColor(name);
        cell.appendChild(span);
        cell.appendChild(document.createElement("br"));
      });
    }

    function toggleUser(cell) {
      if (!currentUser) return alert("ë¨¼ì € ì´ë¦„ì„ ë“±ë¡í•´ì£¼ì„¸ìš”!");
      const key = cell.dataset.key;
      if (visited.has(key)) return;
      visited.add(key);
      const ref = db.ref(`schedule/${key}/${currentUser}`);
      ref.once("value").then(snap => {
        if (snap.exists()) ref.remove();
        else ref.set(true);
        // DOM ì¦‰ì‹œ ë°˜ì˜
        const users = Array.from(cell.querySelectorAll(".name-label")).map(span => span.textContent);
        const updated = snap.exists() ? users.filter(n => n !== currentUser) : [...users, currentUser];
        updateCellDisplay(cell, updated);
      });
    }

    function clearMySchedule() {
      if (!currentUser) return alert("ë¨¼ì € ì´ë¦„ì„ ë“±ë¡í•´ì£¼ì„¸ìš”!");
      for (let h = 0; h < 24; h++) {
        for (let d = 0; d < 7; d++) {
          db.ref(`schedule/${d}-${h}/${currentUser}`).remove();
        }
      }
      alert("ë‚´ ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function createTable() {
      for (let h = 0; h < 24; h++) {
        const row = document.createElement("tr");
        const time = document.createElement("th");
        time.textContent = `${String(h).padStart(2, "0")}:00`;
        row.appendChild(time);
        for (let d = 0; d < 7; d++) {
          const cell = document.createElement("td");
          const key = `${d}-${h}`;
          cell.dataset.key = key;

          db.ref(`schedule/${key}`).on("value", snap => {
            const data = snap.val();
            const names = data ? Object.keys(data) : [];
            updateCellDisplay(cell, names);
          });

          cell.addEventListener("mousedown", () => {
            isMouseDown = true;
            visited.clear();
            toggleUser(cell);
          });
          cell.addEventListener("mouseover", () => {
            if (isMouseDown) toggleUser(cell);
          });
          row.appendChild(cell);
        }
        tableBody.appendChild(row);
      }
    }

    document.body.addEventListener("mouseup", () => {
      isMouseDown = false;
      visited.clear();
    });

    createTable();
  </script>
</body>
</html>
